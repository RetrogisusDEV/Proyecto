<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <meta name="description" content="Sistema de gesti√≥n de nodos y reportes con mapa interactivo">
    <meta name="theme-color" content="#0077b6">
    
    <!-- Preload cr√≠tico -->
    <link rel="preload" href="styles/normalize.css" as="style">
    <link rel="preload" href="styles/style.css" as="style">
    
    <link rel="stylesheet" href="styles/normalize.css" />
    <link rel="stylesheet" href="styles/style.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v10.6.0/ol.css" />
    
    <title>StarNet - Sistema de Gesti√≥n de Nodos</title>
    
    <!-- Estilos cr√≠ticos inline para mejor renderizado -->
    <style>
      /* Estilos cr√≠ticos para el popup del mapa */
      .ol-popup {
        position: absolute;
        background-color: white;
        box-shadow: 0 1px 4px rgba(0,0,0,0.2);
        padding: 15px;
        border-radius: 10px;
        border: 1px solid #cccccc;
        bottom: 12px;
        left: -50px;
        min-width: 280px;
      }
      .ol-popup:after, .ol-popup:before {
        top: 100%;
        border: solid transparent;
        content: " ";
        height: 0;
        width: 0;
        position: absolute;
        pointer-events: none;
      }
      .ol-popup:after {
        border-top-color: white;
        border-width: 10px;
        left: 48px;
        margin-left: -10px;
      }
      .ol-popup:before {
        border-top-color: #cccccc;
        border-width: 11px;
        left: 48px;
        margin-left: -11px;
      }

      /* Loading state inicial (MEJORADO) */
      /* Se oculta cuando el mapa tiene la clase 'map-loaded' */
      #map:not(.map-loaded)::before {
        content: 'Cargando mapa...';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 1;
        background: white;
        padding: 10px 20px;
        border-radius: 5px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      }
    </style>
</head>
<body>
    <!-- Header sem√°ntico mejorado -->
    <header class="navbar" role="banner">
        <h1 class="navbar-title">StarNet System</h1>
        <nav class="navbar-nav" role="navigation" aria-label="Navegaci√≥n principal">
            <button id="btnReportes" class="nav-btn active" aria-pressed="true">
                <span class="nav-btn-icon">üìä</span>
                <span class="nav-btn-text">Reportes</span>
            </button>
            <button id="btnNodos" class="nav-btn" aria-pressed="false">
                <span class="nav-btn-icon">üìç</span>
                <span class="nav-btn-text">Nodos</span>
            </button>
            <button id="btnMenu" class="nav-btn" aria-pressed="false">
                <span class="nav-btn-icon">‚ò∞</span>
                <span class="nav-btn-text">Men√∫</span>
            </button>
        </nav>
    </header>

    <!-- Paneles laterales con sem√°ntica mejorada -->
    <aside class="content-left" id="sidebar-info" role="complementary" aria-label="Informaci√≥n del nodo">
        <span class="sidebar-title">Informaci√≥n del Nodo</span>
        <!-- Contenedor para el contenido din√°mico -->
        <div class="sidebar-content" id="sidebarContent">
            <div class="loading-state" id="infoLoading">
                <span>Selecciona un nodo o un marcador en el mapa para ver sus detalles.</span>
            </div>
        </div>
    </aside>

    <aside class="content-right" id="sidebar-nodes" role="complementary" aria-label="Lista de nodos y reportes">
        <span class="sidebar-title" id="sidebarTitle">Reportes</span>
        <!-- Contenedor para la lista din√°mica -->
        <div class="node-list" id="nodeList" role="list" aria-label="Lista de elementos">
            <div class="loading-state" id="nodeListLoading">
                <span>Cargando...</span>
            </div>
        </div>
    </aside>

    <!-- Contenido principal -->
    <main role="main">
        <div class="content">
            <div id="map" role="application" aria-label="Mapa interactivo de nodos">
                <!-- El mapa se carga aqu√≠ -->
            </div>
        </div>
    </main>

    <!-- Scripts con defer y orden optimizado -->
    <script src="https://cdn.jsdelivr.net/npm/ol@v10.6.0/dist/ol.js" defer></script>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-app-compat.js" defer></script>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-database-compat.js" defer></script>
    
    <!-- Script principal con manejo de errores -->
    <script>
        // Verificaci√≥n de carga de dependencias
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                // Esperar a que las librer√≠as est√©n cargadas (defer se ejecuta antes de DOMContentLoaded)
                if (typeof ol === 'undefined') {
                    throw new Error('OpenLayers no se carg√≥ correctamente');
                }
                if (typeof firebase === 'undefined') {
                    throw new Error('Firebase no se carg√≥ correctamente');
                }
                
                // Inicializar la aplicaci√≥n (definida en app.js)
                await initApplication();

                // Conectar botones de navegaci√≥n (MEJORADO)
                const btnReportes = document.getElementById('btnReportes');
                const btnNodos = document.getElementById('btnNodos');
                
                btnReportes.addEventListener('click', () => {
                    AppManager.setActiveSection('Reportes');
                    btnReportes.classList.add('active');
                    btnNodos.classList.remove('active');
                    btnReportes.setAttribute('aria-pressed', 'true');
                    btnNodos.setAttribute('aria-pressed', 'false');
                });

                btnNodos.addEventListener('click', () => {
                    AppManager.setActiveSection('Nodos');
                    btnNodos.classList.add('active');
                    btnReportes.classList.remove('active');
                    btnNodos.setAttribute('aria-pressed', 'true');
                    btnReportes.setAttribute('aria-pressed', 'false');
                });

            } catch (error) {
                console.error('Error inicializando la aplicaci√≥n:', error);
                showErrorToUser('Error al cargar la aplicaci√≥n. Por favor, recarga la p√°gina.');
            }
        });

        function showErrorToUser(message) {
            const errorDiv = document.createElement('div');
            errorDiv.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: #ef4444;
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                z-index: 10000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            `;
            errorDiv.textContent = message;
            document.body.appendChild(errorDiv);
            
            setTimeout(() => errorDiv.remove(), 5000);
        }
    </script>
    
    <!-- Script de la aplicaci√≥n separado (RUTA CORREGIDA) -->
    <script src="components/app.js" defer></script>
</body>
</html>
